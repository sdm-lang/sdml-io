<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-12-20 Wed 11:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RFC003: Remove groups from product types</title>
<meta name="author" content="Simon Johnston" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="./rfcs.css"/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./index.html"> UP </a>
 |
 <a accesskey="H" href="./index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">RFC003: Remove groups from product types</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org137ff34">1. Introduction</a></li>
<li><a href="#org1dd788b">2. Motivation</a></li>
<li><a href="#org4264220">3. Proposed Change</a></li>
</ul>
</div>
</div>

<div id="outline-container-org137ff34" class="outline-2">
<h2 id="org137ff34"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
The grammar production <code>member_group</code> seems to provide little value, any example using it seems better off with another
structure. While writing the primer it became clear that no good example could be described that motivated the group
production in a definitive way.
</p>

<p>
<b>Document Status History</b>
</p>

<table border="0" cellspacing="0" cellpadding="6" rules="none" frame="none">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Date</th>
<th scope="col" class="org-left">Status</th>
<th scope="col" class="org-left">Comment</th>
<th scope="col" class="org-left">Grammar Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><span class="timestamp-wrapper"><span class="timestamp">[2023-12-07 Thu]</span></span></td>
<td class="org-left">Draft</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>0.2.6</code></td>
</tr>

<tr>
<td class="org-left"><span class="timestamp-wrapper"><span class="timestamp">[2023-12-07 Thu]</span></span></td>
<td class="org-left">Proposed</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>0.2.6</code></td>
</tr>

<tr>
<td class="org-left"><span class="timestamp-wrapper"><span class="timestamp">[2023-12-20 Wed]</span></span></td>
<td class="org-left">Approved</td>
<td class="org-left">Removed and <a href="https://github.com/sdm-lang/tree-sitter-sdml/releases/v0.2.7">released</a>.</td>
<td class="org-left"><code>0.2.7</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org1dd788b" class="outline-2">
<h2 id="org1dd788b"><span class="section-number-2">2.</span> Motivation</h2>
<div class="outline-text-2" id="text-2">
<p>
The current implementation allows for a grouping of fields in a structure such that annotations are attached to the
group not to individual members.
</p>

<div class="org-src-container">
<pre class="src src-ebnf">StructureDef
    ::= <span style="color: #2aa198;">"structure"</span> Identifier StructuredBody?

StructuredBody
    ::= <span style="color: #2aa198;">"is"</span> Annotation* StructuredBodyInner <span style="color: #2aa198;">"end"</span>

StructuredBodyInner
    ::= <span style="color: #657b83;">(</span> MemberGroup | Member <span style="color: #657b83;">)</span>+

MemberGroup
    ::= <span style="color: #2aa198;">"group"</span> Annotation* Member+ <span style="color: #2aa198;">"end"</span>
</pre>
</div>

<p>
For example, this is an excerpt from the file <code>examples/simple.sdm</code> which grouped three fields in the invoice and labeled
the group as rates applied. However, it&rsquo;s not clear what we do with this when we transform the model; does the group
represent a type? do attributes get copied to each field? is the group (and annotations) simply get discarded?
</p>

<div class="org-src-container">
<pre class="src src-sdml"><span style="color: #859900;">module</span> <span style="color: #268bd2;">invoice</span> <span style="color: #859900;">is</span>
  <span style="color: #859900;">entity</span> <span style="color: #268bd2;">Invoice</span> <span style="color: #859900;">is</span>
    <span style="color: #859900;">identity</span> id <span style="color: #859900;">-&gt;</span> <span style="color: #6c71c4;">integer</span>
    customer <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">customers:Customer</span>
    vehicle <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">vehicles:Vehicle</span>
    rental_dates <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">DateRange</span>
    mileage <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">OdometerRange</span>

    <span style="color: #859900;">group</span>
      <span style="color: #d33682;">@dc:description</span> <span style="color: #859900;">=</span> <span style="color: #2aa198;">"Rates applied to the rental."</span><span style="color: #268bd2; font-style: italic;">@en</span>
      day_rate <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:CurrencyRate</span>
      mile_rate <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:CurrencyRate</span>
      discount <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:DiscountPercentage</span>
    <span style="color: #859900;">end</span>

  <span style="color: #859900;">end</span>
<span style="color: #859900;">end</span>
</pre>
</div>

<p>
It is also hard to come up with examples for the documentation where a group of this kind is preferred to a new
structure, as in the following. This would suggest that the group notion is not required as a core component of the language.
</p>

<div class="org-src-container">
<pre class="src src-sdml"><span style="color: #859900;">module</span> <span style="color: #268bd2;">invoice</span> <span style="color: #859900;">is</span>
  <span style="color: #859900;">entity</span> <span style="color: #268bd2;">Invoice</span> <span style="color: #859900;">is</span>
    <span style="color: #859900;">identity</span> id <span style="color: #859900;">-&gt;</span> <span style="color: #6c71c4;">integer</span>
    customer <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">customers:Customer</span>
    vehicle <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">vehicles:Vehicle</span>
    rental_dates <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">DateRange</span>
    mileage <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">OdometerRange</span>

    rates <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">RentalRates</span>
  <span style="color: #859900;">end</span>

  <span style="color: #859900;">structure</span> <span style="color: #268bd2;">RentalRates</span> <span style="color: #859900;">is</span>
    <span style="color: #d33682;">@dc:description</span> <span style="color: #859900;">=</span> <span style="color: #2aa198;">"Rates applied to the rental."</span><span style="color: #268bd2; font-style: italic;">@en</span>
    day_rate <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:CurrencyRate</span>
    mile_rate <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:CurrencyRate</span>
    discount <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">finance:DiscountPercentage</span>
  <span style="color: #859900;">end</span>
  
<span style="color: #859900;">end</span>
</pre>
</div>

<p>
In the case where the grouping of fields was not intended to imply a nested structure it would be possible to add an
annotation property that would affect code generation to <i>flatten</i> a structure into its parent.
</p>

<div class="org-src-container">
<pre class="src src-sdml"><span style="color: #859900;">module</span> <span style="color: #268bd2;">invoice</span> <span style="color: #859900;">is</span>
  <span style="color: #859900;">entity</span> <span style="color: #268bd2;">Invoice</span> <span style="color: #859900;">is</span>
    <span style="color: #859900;">identity</span> id <span style="color: #859900;">-&gt;</span> <span style="color: #6c71c4;">integer</span>
    // <span style="color: #859900;">..</span>.

    rates <span style="color: #859900;">-&gt;</span> <span style="color: #268bd2;">RentalRates</span> <span style="color: #859900;">is</span>
      <span style="color: #d33682;">@generator:flattened</span> <span style="color: #859900;">=</span> <span style="color: #6c71c4;">true</span>
    <span style="color: #859900;">end</span>
  <span style="color: #859900;">end</span>  
<span style="color: #859900;">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4264220" class="outline-2">
<h2 id="org4264220"><span class="section-number-2">3.</span> Proposed Change</h2>
<div class="outline-text-2" id="text-3">
<p>
The following changes are required:
</p>

<ol class="org-ol">
<li>Remove the production <code>member_group</code> from the grammar.</li>
<li>Remove the production <code>_structured_body_inner</code> from the grammar.</li>
<li>Update <code>structure_body</code> and <code>entity_body</code> to include <code>repeat1(member)</code> and <code>repeat(member)</code> respectively.</li>
<li>Update queries for highlights, indents, and folds to remove <code>member_group</code> references.</li>
<li>Remove test case <code>entity_with_groups.sdm</code>.</li>
<li>Update test case <code>entity_with_unknowns.sdm</code> to remove group.</li>
<li>Update example <code>simple.sdm</code> to remove group.</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Simon Johnston</p>
<p class="date">Created: 2023-12-20 Wed 11:47</p>
</div>
</body>
</html>
